# -*- coding: utf8 -*-
from __future__ import print_function
from __future__ import division
from pymongo import MongoClient
from bson import json_util
from datetime import datetime
import pytz, time
import cfscrape
from colorama import init
from colorama import Fore, Back, Style
init()

exchange = 'Bitfinex'
bookTickerURL = "https://api.bitfinex.com/v1/symbols_details"
scraper = cfscrape.create_scraper()
client = MongoClient()
db = client.bitfinex
data_json = ''
interval = 5

d = datetime.now(tz=pytz.utc)
dFormatted = Fore.GREEN + d.strftime('%d/%m/%Y %H:%M:%S') + Style.RESET_ALL
print("{} {} assetPairs started...".format(dFormatted, exchange))

data_json = {"_id":'',"timestamp":'',"valid":'false',"error":[],"result":{}}

oldData_json = """[{"pair":"btcusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"2000.0","minimum_order_size":"0.002","expiration":"NA","margin":true},{"pair":"ltcusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"5000.0","minimum_order_size":"0.08","expiration":"NA","margin":true},{"pair":"ltcbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"5000.0","minimum_order_size":"0.08","expiration":"NA","margin":true},{"pair":"ethusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"5000.0","minimum_order_size":"0.02","expiration":"NA","margin":true},{"pair":"ethbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"5000.0","minimum_order_size":"0.02","expiration":"NA","margin":true},{"pair":"etcbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"100000.0","minimum_order_size":"0.6","expiration":"NA","margin":true},{"pair":"etcusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"100000.0","minimum_order_size":"0.6","expiration":"NA","margin":true},{"pair":"rrtusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"100000.0","minimum_order_size":"80.0","expiration":"NA","margin":true},{"pair":"rrtbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"100000.0","minimum_order_size":"80.0","expiration":"NA","margin":true},{"pair":"zecusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"20000.0","minimum_order_size":"0.04","expiration":"NA","margin":true},{"pair":"zecbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"20000.0","minimum_order_size":"0.04","expiration":"NA","margin":true},{"pair":"xmrusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"5000.0","minimum_order_size":"0.06","expiration":"NA","margin":true},{"pair":"xmrbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"5000.0","minimum_order_size":"0.06","expiration":"NA","margin":true},{"pair":"dshusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"5000.0","minimum_order_size":"0.02","expiration":"NA","margin":true},{"pair":"dshbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"5000.0","minimum_order_size":"0.02","expiration":"NA","margin":true},{"pair":"btceur","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"2000.0","minimum_order_size":"0.002","expiration":"NA","margin":true},{"pair":"xrpusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"10.0","expiration":"NA","margin":true},{"pair":"xrpbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"10.0","expiration":"NA","margin":true},{"pair":"iotusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"100000.0","minimum_order_size":"6.0","expiration":"NA","margin":true},{"pair":"iotbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"100000.0","minimum_order_size":"6.0","expiration":"NA","margin":true},{"pair":"ioteth","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"100000.0","minimum_order_size":"6.0","expiration":"NA","margin":true},{"pair":"eosusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"50000.0","minimum_order_size":"2.0","expiration":"NA","margin":true},{"pair":"eosbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"50000.0","minimum_order_size":"2.0","expiration":"NA","margin":true},{"pair":"eoseth","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"50000.0","minimum_order_size":"2.0","expiration":"NA","margin":true},{"pair":"sanusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"4.0","expiration":"NA","margin":true},{"pair":"sanbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"4.0","expiration":"NA","margin":true},{"pair":"saneth","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"4.0","expiration":"NA","margin":true},{"pair":"omgusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"100000.0","minimum_order_size":"1.0","expiration":"NA","margin":true},{"pair":"omgbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"100000.0","minimum_order_size":"1.0","expiration":"NA","margin":true},{"pair":"omgeth","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"100000.0","minimum_order_size":"1.0","expiration":"NA","margin":true},{"pair":"bchusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"2000.0","minimum_order_size":"0.006","expiration":"NA","margin":true},{"pair":"bchbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"2000.0","minimum_order_size":"0.006","expiration":"NA","margin":true},{"pair":"bcheth","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"2000.0","minimum_order_size":"0.006","expiration":"NA","margin":true},{"pair":"neousd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"10000.0","minimum_order_size":"0.2","expiration":"NA","margin":true},{"pair":"neobtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"10000.0","minimum_order_size":"0.2","expiration":"NA","margin":true},{"pair":"neoeth","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"10000.0","minimum_order_size":"0.2","expiration":"NA","margin":true},{"pair":"etpusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"10000.0","minimum_order_size":"4.0","expiration":"NA","margin":true},{"pair":"etpbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"10000.0","minimum_order_size":"4.0","expiration":"NA","margin":true},{"pair":"etpeth","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"10000.0","minimum_order_size":"4.0","expiration":"NA","margin":true},{"pair":"qtmusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"2000.0","minimum_order_size":"0.4","expiration":"NA","margin":true},{"pair":"qtmbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"2000.0","minimum_order_size":"0.4","expiration":"NA","margin":true},{"pair":"qtmeth","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"2000.0","minimum_order_size":"0.4","expiration":"NA","margin":true},{"pair":"avtusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"50000.0","minimum_order_size":"4.0","expiration":"NA","margin":true},{"pair":"avtbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"50000.0","minimum_order_size":"4.0","expiration":"NA","margin":true},{"pair":"avteth","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"50000.0","minimum_order_size":"4.0","expiration":"NA","margin":true},{"pair":"edousd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"50000.0","minimum_order_size":"4.0","expiration":"NA","margin":true},{"pair":"edobtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"50000.0","minimum_order_size":"4.0","expiration":"NA","margin":true},{"pair":"edoeth","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"50000.0","minimum_order_size":"4.0","expiration":"NA","margin":true},{"pair":"btgusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"2000.0","minimum_order_size":"0.06","expiration":"NA","margin":true},{"pair":"btgbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"2000.0","minimum_order_size":"0.06","expiration":"NA","margin":true},{"pair":"datusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"250000.0","minimum_order_size":"74.0","expiration":"NA","margin":true},{"pair":"datbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"250000.0","minimum_order_size":"74.0","expiration":"NA","margin":true},{"pair":"dateth","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"250000.0","minimum_order_size":"74.0","expiration":"NA","margin":true},{"pair":"qshusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"50000.0","minimum_order_size":"10.0","expiration":"NA","margin":true},{"pair":"qshbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"50000.0","minimum_order_size":"10.0","expiration":"NA","margin":true},{"pair":"qsheth","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"50000.0","minimum_order_size":"10.0","expiration":"NA","margin":true},{"pair":"yywusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"50000.0","minimum_order_size":"48.0","expiration":"NA","margin":true},{"pair":"yywbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"50000.0","minimum_order_size":"48.0","expiration":"NA","margin":true},{"pair":"yyweth","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"50000.0","minimum_order_size":"48.0","expiration":"NA","margin":true},{"pair":"gntusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"16.0","expiration":"NA","margin":true},{"pair":"gntbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"16.0","expiration":"NA","margin":true},{"pair":"gnteth","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"16.0","expiration":"NA","margin":true},{"pair":"sntusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"38.0","expiration":"NA","margin":true},{"pair":"sntbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"38.0","expiration":"NA","margin":true},{"pair":"snteth","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"38.0","expiration":"NA","margin":true},{"pair":"ioteur","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"100000.0","minimum_order_size":"4.0","expiration":"NA","margin":true},{"pair":"batusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"18.0","expiration":"NA","margin":true},{"pair":"batbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"18.0","expiration":"NA","margin":true},{"pair":"bateth","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"18.0","expiration":"NA","margin":true},{"pair":"mnausd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"80.0","expiration":"NA","margin":true},{"pair":"mnabtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"80.0","expiration":"NA","margin":true},{"pair":"mnaeth","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"80.0","expiration":"NA","margin":true},{"pair":"funusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"108.0","expiration":"NA","margin":true},{"pair":"funbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"108.0","expiration":"NA","margin":true},{"pair":"funeth","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"108.0","expiration":"NA","margin":true},{"pair":"zrxusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"6.0","expiration":"NA","margin":true},{"pair":"zrxbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"6.0","expiration":"NA","margin":true},{"pair":"zrxeth","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"6.0","expiration":"NA","margin":true},{"pair":"tnbusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"104.0","expiration":"NA","margin":true},{"pair":"tnbbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"104.0","expiration":"NA","margin":true},{"pair":"tnbeth","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"104.0","expiration":"NA","margin":true},{"pair":"spkusd","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"26.0","expiration":"NA","margin":true},{"pair":"spkbtc","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"26.0","expiration":"NA","margin":true},{"pair":"spketh","price_precision":5,"initial_margin":"30.0","minimum_margin":"15.0","maximum_order_size":"200000.0","minimum_order_size":"26.0","expiration":"NA","margin":true}]"""

while True:
    d = datetime.now(tz=pytz.utc)
    ts = time.time()
    valid = 'true'
    if (not d.minute % interval):
        print ("{} Interval".format(d.strftime('%d/%m/%Y %H:%M:%S')))
        try:
            response = scraper.get(bookTickerURL).content
            temp_data_json = json_util.loads(response)
            data_json['result'] = temp_data_json
        except:
            status = 0
            print('{} assetPairs api hatası'.format(exchange))

        if b'btcusd' not in response:
            valid = 'false'
            data_json = oldData_json
            data_json['valid'] = valid
            dFormatted = Fore.RED + d.strftime('%d/%m/%Y %H:%M:%S') + Style.RESET_ALL
            print('Data invalid!')

        data_json['_id'] = int(ts)
        data_json['timestamp'] = d
        data_json['valid'] = valid
        result = db['assetPairs'].insert_one(data_json)

        dFormatted = Fore.GREEN + d.strftime('%d/%m/%Y %H:%M:%S') + Style.RESET_ALL
        print(
            "{} Inserted_id: {}".format(dFormatted, result.inserted_id))

        print('{} assetPairs done...'.format(exchange))
        oldData_json = data_json
        client.close()
        time.sleep(61)
    time.sleep(0.9)

